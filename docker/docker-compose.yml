version: '3.1'

services:

  # Message Broker
  # The settings in the docker container define
  # the vhosts, users, permissions, queues, exchanges and bindings
  mq:
    #env_file: .env.d/mq
    build: images/mq
    hostname: ega-mq
    ports:
      - "5672:5672"
      - "15672:15672"
      # - "4369:4369"
      # - "25672:25672"
      # - "5671:5671"
      # - "15671:15671"
    image: nbis/ega:mq
    container_name: ega-mq

  # Postgres Database
  db:
    env_file: .env.d/db
    build: images/db
    hostname: ega-db
    ports:
      - "5050:5050"
      - "5051:5051"
    container_name: ega-db
    image: nbis/ega:db
    volumes:
       - ./images/db/config_local.py:/usr/local/lib/python2.7/dist-packages/pgadmin4/config_local.py
       - ./entrypoints/db.sh:/usr/local/bin/db.sh:ro
    command: ["db.sh"]

  # SFTP inbox
  inbox:
    #env_file: .env.d/inbox
    build: images/inbox
    hostname: ega-inbox
    depends_on:
      - db
      - mq
    ports:
      - "2222:22"
    container_name: ega-inbox
    image: nbis/ega:inbox
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${INBOX}:/home
       - ./entrypoints/inbox.sh:/usr/local/bin/inbox.sh:ro
    command: inbox.sh

  # ReST frontend
  frontend:
    build: images/common
    depends_on:
      - db
    hostname: ega-frontend
    ports:
      - "9000:9000"
    expose:
      - 9000
    container_name: ega-frontend
    image: nbis/ega:frontend
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ./entrypoints/frontend.sh:/usr/local/bin/frontend.sh:ro
    command: frontend.sh

  # Vault
  vault:
    build: images/common
    depends_on:
      - db
      - mq
    hostname: ega-vault
    container_name: ega-vault
    image: nbis/ega:common
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${VAULT}:/ega/vault
       - ./entrypoints/vault.sh:/usr/local/bin/vault.sh:ro
    command: vault.sh

  # Verify
  verify:
    build: images/common
    depends_on:
      - db
      - mq
    hostname: ega-verify
    container_name: ega-verify
    image: nbis/ega:common
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${VAULT}:/ega/vault
       - ./entrypoints/verify.sh:/usr/local/bin/verify.sh:ro
    command: verify.sh

  # Connectors between CEGA and LEGA
  connectors:
    build: images/common
    depends_on:
      - db
      - mq
    hostname: ega-connectors
    container_name: ega-connectors
    image: nbis/ega:common
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ./entrypoints/connectors.sh:/usr/local/bin/connectors.sh:ro
    command: ["connectors.sh"] 
    # Exec form, not shell form

  # Error Monitors
  monitors:
    build: images/common
    depends_on:
      - db
    hostname: ega-monitors
    container_name: ega-monitors
    image: nbis/ega:common
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ./entrypoints/monitors.sh:/usr/local/bin/monitors.sh:ro
    command: monitors.sh

  # Workers
  worker-1:
    build: images/worker
    depends_on:
      - db
      - mq
      - keys
    hostname: ega-worker-1
    container_name: ega-worker-1
    image: nbis/ega:worker
    tty: true
    stdin_open: true
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${INBOX}:/home
       - ${STAGING}:/ega/staging
       - ${GPG_HOME}/pubring.kbx:/root/.gnupg/pubring.kbx
       - ${GPG_HOME}/trustdb.gpg:/root/.gnupg/trustdb.gpg
       - ${GPG_HOME}/certs/selfsigned.cert:/etc/ega/ega.cert:ro
       - ${RSA_HOME}:/root/.rsa:ro
       - ./entrypoints/worker.sh:/usr/local/bin/worker.sh:ro
    command: worker.sh

  worker-2:
    build: images/worker
    depends_on:
      - db
      - mq
      - keys
    hostname: ega-worker-2
    container_name: ega-worker-2
    image: nbis/ega:worker
    tty: true
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${INBOX}:/home
       - ${STAGING}:/ega/staging
       - ${GPG_HOME}/pubring.kbx:/root/.gnupg/pubring.kbx
       - ${GPG_HOME}/trustdb.gpg:/root/.gnupg/trustdb.gpg
       - ${GPG_HOME}/certs/selfsigned.cert:/etc/ega/ega.cert:ro
       - ${RSA_HOME}:/root/.rsa:ro
       - ./entrypoints/worker.sh:/usr/local/bin/worker.sh:ro
    command: worker.sh


  # GPG Agent
  keys:
    build: images/keys
    env_file: .env.d/gpg
    hostname: ega-keys
    container_name: ega-keys
    image: nbis/ega:keys
    tty: true
    volumes:
       - ${CODE}:/root/ega
       - ${CONF}:/root/.lega/conf.ini:ro
       - ${GPG_HOME}/pubring.kbx:/root/.gnupg/pubring.kbx
       - ${GPG_HOME}/trustdb.gpg:/root/.gnupg/trustdb.gpg
       - ${GPG_HOME}/openpgp-revocs.d:/root/.gnupg/openpgp-revocs.d:ro
       - ${GPG_HOME}/private-keys-v1.d:/root/.gnupg/private-keys-v1.d:ro
       - ${GPG_HOME}/certs/selfsigned.cert:/etc/ega/ega.cert:ro
       - ${GPG_HOME}/certs/selfsigned.key:/etc/ega/ega.key:ro
       - ${RSA_HOME}:/root/.rsa:ro
       - ./entrypoints/keys.sh:/usr/local/bin/keys.sh:ro
    command: ["keys.sh"]
